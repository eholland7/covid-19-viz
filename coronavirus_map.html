<!DOCTYPE html>
<meta charset="utf-8">

<link rel="stylesheet" type="text/css" href="main.css"></link>

<div class="row">
  <div class="col-md-6" id="titlearea"></div>
  <div class="col-md-6" id="chartarea">
    <div class="btn-holder">
      <div id="buttons">
          <button id="bubblesOn">Display Cases</button>
          <button id="bubblesOff">Hide Cases</button>
      </div>
   </div>
  </div>
</div>

<script src="./lib/d3.v5.min.js"></script>
<script src="./lib/d3-scale-chromatic.v1.min.js"></script>
<script src="./lib/topojson.v2.min.js"></script>
<script src="./lib/d3-simple-slider.min.js"></script>
<script src="./lib/d3-tip.min.js"></script>
<script>

//title and info
var svg_title = d3.select("#titlearea").append("svg")
    .attr("width", 1030)
    .attr("height", 85);

svg_title.append("text")
    .attr("text-anchor", "middle")
    .attr("y", 45)
    .attr("x", 365)
    .attr("class", "title-text")
    .text("COVID-19 Cases & Deaths by County:");

svg_title.append("text")
    .attr("text-anchor", "middle")
    .attr("y", 75)
    .attr("x", 390)
    .attr("class", "avg-text")
    .style("font", "12px sans-serif")
    .text("Use the slider to display information for a specific date, and the buttons to view/hide bubbles");

//create chart
var svg = d3.select("#chartarea").append("svg")
    .attr("width", 1230)
    .attr("height", 800);

var covid_cases = d3.map();
var covid_deaths = d3.map();
var regionMap = d3.map();
var countyMap = d3.map();
var parseTime = d3.timeParse("%Y-%m-%d");
var projection = d3.geoAlbersUsa().scale(1150).translate([550, 305])
var path = d3.geoPath().projection(projection);
var dates = [];
var cc = [];

//legend -- for deaths
var x = d3.scaleLinear()
    .domain([1, 50])
    .rangeRound([325, 875]);

var rangeGreys = ["#ffffff","#f0f0f0","#eaeaea","#d9d9d9","#c5c5c5","#bdbdbd", "#a9a9a9"
      ,"#a0a0a0","#969696","#888888","#828282","#737373","#646464","#525252","#3e3e3e"
      ,"#252525","#000000"];

var color = d3.scaleThreshold()
    .domain(d3.range(0, 50, 3))
    .range(rangeGreys);

var g = svg.append("g")
    .attr("class", "key")
    .attr("transform", "translate(60,-280)");//-150,45

g.selectAll("rect")
  .data(color.range().map(function(d) {
      d = color.invertExtent(d);
      if (d[0] == null) d[0] = x.domain()[0];
      if (d[1] == null) d[1] = x.domain()[1];
      return d;
    }))
  .enter().append("rect")
    .attr("width", 8)
    .attr("y", function(d) { return x(d[0]); })
    .attr("height", function(d) { return x(d[1]) - x(d[0]); })
    .attr("fill", function(d) { return color(d[0]); });

g.append("text")
    .attr("class", "caption")
    .attr("x", x.range()[0] + 95)
    .attr("y", -10)
    .attr("fill", "#000")
    .attr("transform", "rotate(90)")
    .style("font", "10px sans-serif")
    .text("Deaths from COVID-19");

g.call(d3.axisLeft(x)
    .tickSize(13)
    .tickFormat(function(x, i) { return (i === 16) ? x + "+" : x ; })
    .tickValues(color.domain()))
  .select(".domain")
    .remove();

//legend -- for cases
var bubbles_legend = svg.selectAll(".bubbles-legend")
    .data([2000, 5000, 10000])
    .enter().append("circle")
    .attr("class", "bubbles-legend")
    .attr("r", function(d) {
      return Math.sqrt(d) / (Math.PI / 2);
    })
    .attr("transform", "translate(990,550)")
    .attr("cy", d => -(Math.sqrt(d) / (Math.PI / 2)));

svg.append("text")
      .attr("transform", "translate(990,503)")
      .attr("text-anchor", "middle")
      .style("font", "10px sans-serif")
      .attr("fill", "#900")
      .text("2k");
svg.append("text")
      .attr("transform", "translate(990,470)")
      .attr("text-anchor", "middle")
      .style("font", "10px sans-serif")
      .attr("fill", "#900")
      .text("5k");
svg.append("text")
      .attr("transform", "translate(990,433)")
      .attr("text-anchor", "middle")
      .style("font", "10px sans-serif")
      .attr("fill", "#900")
      .text("10k");
svg.append("text")
      .attr("transform", "translate(990,563)")
      .attr("text-anchor", "middle")
      .style("font", "10px sans-serif")
      .text("Cases of COVID-19");

// tooltip
function strong(text) {
    return "<strong>" + text + "</strong>"
}

var tip = d3.tip()
    .attr("class", "tip")
    .offset([-5, 0])
    .html(function(d) {
        var county = d.properties.name;
        var state = regionMap.get(+d.id);
        var cases = covid_cases.get(d.id);
        var deaths = covid_deaths.get(d.id);
        if (cases === undefined) {
             cases = 0;
        }
        if (deaths === undefined) {
             deaths = 0;
        }
        return "State: " + strong(state) +
            "<br>County: " + strong(county) +
            "<br>Cases: " + strong(cases) +
            "<br>Deaths: " + strong(deaths) + "</span>";
    });

svg.call(tip);

function handleMouseOver(d) {
    tip.show(d);
    d3.select(this)
        .attr("stroke", "white")
    };
function handleMouseOut(d) {
    tip.hide(d);
    d3.select(this)
        .attr("stroke", "none")
        .attr("stroke", "none")
    };

//slider to view the data as it happened
//set og value
updateData(parseTime('2020-03-30'));

var dispatch = d3.dispatch("input", "statechange");
var slider = d3.sliderBottom()
    .min(parseTime("2020-01-21"))
    .max(parseTime("2020-03-30"))
    .width(550)
    .tickFormat(d3.timeFormat("%m-%d"))
    .tickValues(dates.forEach(element => parseTime(element)))
    .default(parseTime("2020-03-30"))
    .handle(
      d3
        .symbol()
        .type(d3.symbolCircle)
        .size(200)()
    )
    .on("end", function(value) {

      updateData(value);
      d3.selectAll(".bubbles").remove();
      d3.selectAll(".bubbles")
        .transition()
        .duration(10)
        .attr("r", function(d) {
          d.initCovid = covid_cases.get(d.id);
          if (d.initCovid === undefined || d.initCovid < 1) {
              d.value = 0;
          } else {
              d.value = d.initCovid;
          }
          return Math.sqrt(d.value) / (Math.PI/2);
        })
        .attr("cx", function(d) { return path.centroid(d)[0] })
        .attr("cy", function(d) { return path.centroid(d)[1] })
        .style("fill", "#900");
    });

svg.append("g")
    .call(slider)
    .attr("transform", "translate(300,20)");//"translate(770,160)");

//button details
d3.selectAll("button")
  .on("click", function() {
    var bubbleType = this.id;
    d3.selectAll(".bubbles")
        .transition()
        .duration(500)
        .attr("r", function(d) {
          return (bubbleType == "bubblesOff" ? 0 : Math.sqrt(covid_cases.get(d.id)) / (Math.PI / 2));
        })
  });

/*****************************************************************************/

//get data
function updateData(newDate) {

  covid_cases.clear();
  covid_deaths.clear();

  var promises = [
    d3.json("./counties-10m.json"),
    d3.csv("./data/covid-counties.csv", function(data) {
      if (parseTime(data.date) <= newDate) {
        dates.push(parseTime(data.date));
        covid_cases.set(data.fips, +data.cases);
        covid_deaths.set(data.fips, +data.deaths);
        countyMap.set(data.fips, data.county);
      }
    }),
    d3.csv("./data/state_county_map.csv", function(d) {
      regionMap.set(+d.fips, d.state);
    })
  ]

  Promise.all(promises).then(ready)
};

function removeDuplicates(array) {
  let x = {};
  array.forEach(function(i) {
    if(!x[i]) {
      x[i] = true
    }
  })
  return Object.keys(x)
};

//plot data
function ready([us]) {

  dates = removeDuplicates(dates);
  dates.sort(function (a, b) {
    var key1 = new Date(a.date);
    var key2 = new Date(b.date);

    if (key1 < key2) {
        return 1;
    } else if (key1 == key2) {
        return 0;
    } else {
        return -1;
    }
  });

  svg.append("g")
      .attr("class", "counties")
    .selectAll("path")
    .data(topojson.feature(us, us.objects.counties).features)
    .enter().append("path")
      .attr("fill", "#DCDCDC")
      .attr("fill", function(d) {
          d.initCovidd = covid_deaths.get(d.id);
          if (d.initCovidd === undefined || d.initCovidd < 1) {
            d.value = 0;
          } else {
            d.value = d.initCovidd;
          }
          return color(d.value);
        })
      .attr("d", path)
      .on("mouseover", handleMouseOver)
      .on("mouseout", handleMouseOut);

  svg.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a !== b; }))
      .attr("class", "states")
      .attr("d", path);

  var bubbies = svg.selectAll(".bubbles")
      .data(topojson.feature(us, us.objects.counties).features)
      .enter().append("circle")
      .attr("class", "bubbles")
      .attr("r", function(d) {
          d.initCovid = covid_cases.get(d.id);
          if (d.initCovid === undefined || d.initCovid < 1) {
              d.value = 0;
          } else {
              d.value = d.initCovid;
          }
          return Math.sqrt(d.value) / (Math.PI / 2);
      })
      .attr("cx", function(d) { return path.centroid(d)[0] })
      .attr("cy", function(d) { return path.centroid(d)[1] })
      .style("fill", "#900")
      .on("mouseover", handleMouseOver)
      .on("mouseout", handleMouseOut);
}
</script>
